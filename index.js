#!/usr/bin/env node
"use strict";var _random2=require("lodash/random"),_random3=_interopRequireDefault(_random2),_commander=require("commander"),_commander2=_interopRequireDefault(_commander),_ws=require("ws"),_ws2=_interopRequireDefault(_ws),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_moment=require("moment"),_moment2=_interopRequireDefault(_moment),_numeral=require("numeral"),_numeral2=_interopRequireDefault(_numeral);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _toArray(a){return Array.isArray(a)?a:Array.from(a)}require("numeral/locales/de"),_commander2.default.description("Very basic WebSocket that simulates the Deepbot API").option("-k, --api-key [api-key]","API key used to give access","1234").option("-p, --port [port]","Port the WebSocket listens to",Number,3337).option("-w, --no-color","Port the WebSocket listens to").option("-n, --no-users","Keep the initial user database empty").option("-a, --auth-all","Automatically authenticate new clients").option("-r, --randomLatency [latency]","Adds response latencies from 0 to [latency] ms",Number).parse(process.argv),_chalk2.default.enabled=!_commander2.default.noColor;var server,userData=_commander2.default.noUsers?{}:{j4idn:{user:"j4idn",points:13.37,watchtime:9412,vip:10,mod:5,join_date:(0,_moment2.default)().subtract(7,"days").valueOf(),last_seen:(0,_moment2.default)().valueOf(),vip_expiry:(0,_moment2.default)().add(30,"days").valueOf()}};try{server=new _ws2.default.Server({port:_commander2.default.port})}catch(a){console.error(a),process.exit(1)}server.on("connection",function(a,b){var c=_commander2.default.authAll,d=b.connection.remoteAddress;console.log(_chalk2.default.green("["+d+"] Connected!")),a.on("message",function(b){var e=b.split("|"),f=_toArray(e),g=f[0],h=f[1],i=f.slice(2);console.log(_chalk2.default.blue("["+d+"] \uD83E\uDC7A "+JSON.stringify({apiName:g,command:h,args:i}))),new Promise(function(a){setTimeout(a,(0,_random3.default)(0,_commander2.default.randomLatency))}).then(function(){return resolveApiCall(c,g,h,i)}).then(function(b){console.log(_chalk2.default.gray("["+d+"] \uD83E\uDC78 "+JSON.stringify(b))),a.send(JSON.stringify(b,null,4))}).catch(function(a){return console.log(_chalk2.default.gray("["+d+"] \u26A0 "+a))})}),a.on("close",function(){console.log(_chalk2.default.red("["+d+"] Disconnected!"))})}),console.log(_chalk2.default.yellow("Deepbot API WebSocket running on ws://127.0.0.1:"+_commander2.default.port)),_commander2.default.authAll?console.log(_chalk2.default.yellow("--auth-all is enabled")):console.log(_chalk2.default.yellow("You can log in with api|register|"+_commander2.default.apiKey)),process.stdin.setEncoding("utf8"),process.stdin.on("readable",function(){var a=process.stdin.read()});function resolveApiCall(a,b,c,d){return new Promise(function(e,f){if("api"!==b)return void f("First parameter must be \"api\", but it is "+b);if(!c)return void f("command is "+c);if("register"===c)return d[0]===_commander2.default.apiKey?e({function:"register",param:"register",msg:"success"}):e({function:"register",param:"error",msg:"incorrect api secret"}),void(a=!0);if(!a)return void e({function:c,param:"error",msg:"not authorized"});if("get_user"===c){var g=userData[d[0]];return void(g?e({function:c,param:d[0],msg:userToJson(g)}):f("User "+d[0]+" not found!"))}if("get_points"===c){var h=userData[d[0]];return void(h?(_numeral2.default.locale("de"),e({function:c,param:d[0],msg:(0,_numeral2.default)(h.points).format("0.00")}),_numeral2.default.locale("en")):f("User "+d[0]+" not found!"))}if("add_points"===c){var i=userData[d[0]],j=d[1];if(i){if(!j)return void f("Missing parameter!");i.points+=j,e({function:c,param:d[0],msg:"success"})}else f("User "+d[0]+" not found!")}})}function userToJson(a){return{user:a.user,points:(0,_numeral2.default)(a.points).format("0.0"),watchtime:(0,_numeral2.default)(a.watchtime).format("0.0"),vip:a.vip,mod:a.mod,join_date:(0,_moment2.default)(a.join_date).format(),last_seen:(0,_moment2.default)(a.last_seen).format(),vip_expiry:(0,_moment2.default)(a.vip_expiry).format()}}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzeCJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiZGVzY3JpcHRpb24iLCJvcHRpb24iLCJOdW1iZXIiLCJwYXJzZSIsInByb2Nlc3MiLCJhcmd2IiwiZW5hYmxlZCIsIm5vQ29sb3IiLCJzZXJ2ZXIiLCJ1c2VyRGF0YSIsIm5vVXNlcnMiLCJqNGlkbiIsInVzZXIiLCJwb2ludHMiLCJ3YXRjaHRpbWUiLCJ2aXAiLCJtb2QiLCJqb2luX2RhdGUiLCJzdWJ0cmFjdCIsInZhbHVlT2YiLCJsYXN0X3NlZW4iLCJ2aXBfZXhwaXJ5IiwiYWRkIiwiU2VydmVyIiwicG9ydCIsImNvbnNvbGUiLCJlcnJvciIsImV4aXQiLCJvbiIsImF1dGhBbGwiLCJjb25uZWN0aW9uIiwicmVtb3RlQWRkcmVzcyIsImxvZyIsImdyZWVuIiwic3BsaXQiLCJibHVlIiwiSlNPTiIsInN0cmluZ2lmeSIsImFwaU5hbWUiLCJjb21tYW5kIiwiYXJncyIsIlByb21pc2UiLCJzZXRUaW1lb3V0IiwicmFuZG9tTGF0ZW5jeSIsInRoZW4iLCJyZXNvbHZlQXBpQ2FsbCIsImdyYXkiLCJzZW5kIiwiY2F0Y2giLCJyZWQiLCJ5ZWxsb3ciLCJhcGlLZXkiLCJzdGRpbiIsInNldEVuY29kaW5nIiwicmVhZCIsInBhcmFtIiwibXNnIiwidXNlclRvSnNvbiIsImxvY2FsZSIsImZvcm1hdCJdLCJtYXBwaW5ncyI6IjZpQkFRQUEsUUFBUSxvQkFBUixDLENBRUEsb0JBQ0tDLFdBREwsQ0FDaUIscURBRGpCLEVBRUtDLE1BRkwsQ0FFWSx5QkFGWixDQUV1Qyw2QkFGdkMsQ0FFc0UsTUFGdEUsRUFHS0EsTUFITCxDQUdZLG1CQUhaLENBR2lDLCtCQUhqQyxDQUdrRUMsTUFIbEUsQ0FHMEUsSUFIMUUsRUFJS0QsTUFKTCxDQUlZLGdCQUpaLENBSThCLCtCQUo5QixFQUtLQSxNQUxMLENBS1ksZ0JBTFosQ0FLOEIsc0NBTDlCLEVBTUtBLE1BTkwsQ0FNWSxnQkFOWixDQU04Qix3Q0FOOUIsRUFPS0Es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QURwQixDQUVBLEtBQVUsQ0FDTixHQUFJLEVBQUosQ0FFSSxXQURBLEdBQU8sb0JBQVAsQ0FDQSxDQUVKLEVBQUtJLE1BQUwsR0FMTSxDQU1OLEVBQVEsQ0FBQyxVQUFELENBQXNCMEMsTUFBTyxFQUFLLENBQUwsQ0FBN0IsQ0FBc0NDLElBQUssU0FBM0MsQ0FBUixDQUNILENBUEQsSUFRSSxXQUFlLEVBQUssQ0FBTCxDQUFmLGVBR1AsQ0FFSixDQWpFTSxDQWtFVixDQUVELFFBQVNDLFdBQVQsR0FBMEIsQ0FDdEIsTUFBTyxDQUNIN0MsS0FBTSxFQUFLQSxJQURSLENBRUhDLE9BQVEsc0JBQVEsRUFBS0EsTUFBYixFQUFxQjhDLE1BQXJCLENBQTRCLEtBQTVCLENBRkwsQ0FHSDdDLFVBQVcsc0JBQVEsRUFBS0EsU0FBYixFQUF3QjZDLE1BQXhCLENBQStCLEtBQS9CLENBSFIsQ0FJSDVDLElBQUssRUFBS0EsR0FKUCxDQUtIQyxJQUFLLEVBQUtBLEdBTFAsQ0FNSEMsVUFBVyxxQkFBTyxFQUFLQSxTQUFaLEVBQXVCMEMsTUFBdkIsRUFOUixDQU9IdkMsVUFBVyxxQkFBTyxFQUFLQSxTQUFaLEVBQXVCdUMsTUFBdkIsRUFQUixDQVFIdEMsV0FBWSxxQkFBTyxFQUFLQSxVQUFaLEVBQXdCc0MsTUFBeEIsRUFSVCxDQVVWIiwiZmlsZSI6ImluZGV4LmpzeCIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHByb2dyYW0gZnJvbSBcImNvbW1hbmRlclwiXG5pbXBvcnQgbG9kYXNoIGZyb20gXCJsb2Rhc2hcIlxuaW1wb3J0IFdlYlNvY2tldCBmcm9tIFwid3NcIlxuaW1wb3J0IGNoYWxrIGZyb20gXCJjaGFsa1wiXG5pbXBvcnQgbW9tZW50IGZyb20gXCJtb21lbnRcIlxuaW1wb3J0IG51bWVyYWwgZnJvbSBcIm51bWVyYWxcIlxuXG5yZXF1aXJlKFwibnVtZXJhbC9sb2NhbGVzL2RlXCIpXG5cbnByb2dyYW1cbiAgICAuZGVzY3JpcHRpb24oXCJWZXJ5IGJhc2ljIFdlYlNvY2tldCB0aGF0IHNpbXVsYXRlcyB0aGUgRGVlcGJvdCBBUElcIilcbiAgICAub3B0aW9uKFwiLWssIC0tYXBpLWtleSBbYXBpLWtleV1cIiwgXCJBUEkga2V5IHVzZWQgdG8gZ2l2ZSBhY2Nlc3NcIiwgXCIxMjM0XCIpXG4gICAgLm9wdGlvbihcIi1wLCAtLXBvcnQgW3BvcnRdXCIsIFwiUG9ydCB0aGUgV2ViU29ja2V0IGxpc3RlbnMgdG9cIiwgTnVtYmVyLCAzMzM3KVxuICAgIC5vcHRpb24oXCItdywgLS1uby1jb2xvclwiLCBcIlBvcnQgdGhlIFdlYlNvY2tldCBsaXN0ZW5zIHRvXCIpXG4gICAgLm9wdGlvbihcIi1uLCAtLW5vLXVzZXJzXCIsIFwiS2VlcCB0aGUgaW5pdGlhbCB1c2VyIGRhdGFiYXNlIGVtcHR5XCIpXG4gICAgLm9wdGlvbihcIi1hLCAtLWF1dGgtYWxsXCIsIFwiQXV0b21hdGljYWxseSBhdXRoZW50aWNhdGUgbmV3IGNsaWVudHNcIilcbiAgICAub3B0aW9uKFwiLXIsIC0tcmFuZG9tTGF0ZW5jeSBbbGF0ZW5jeV1cIiwgXCJBZGRzIHJlc3BvbnNlIGxhdGVuY2llcyBmcm9tIDAgdG8gW2xhdGVuY3ldIG1zXCIsIE51bWJlcilcbiAgICAucGFyc2UocHJvY2Vzcy5hcmd2KVxuXG5jaGFsay5lbmFibGVkID0gIXByb2dyYW0ubm9Db2xvclxuXG5jb25zdCB1c2VyRGF0YSA9IHByb2dyYW0ubm9Vc2Vyc1xuICAgID8ge31cbiAgICA6IHtcbiAgICAgICAgajRpZG46IHtcbiAgICAgICAgICAgIHVzZXI6IFwiajRpZG5cIixcbiAgICAgICAgICAgIHBvaW50czogMTMuMzcsXG4gICAgICAgICAgICB3YXRjaHRpbWU6IDk0MTIsXG4gICAgICAgICAgICB2aXA6IDEwLFxuICAgICAgICAgICAgbW9kOiA1LFxuICAgICAgICAgICAgam9pbl9kYXRlOiBtb21lbnQoKS5zdWJ0cmFjdCg3LCBcImRheXNcIikudmFsdWVPZigpLFxuICAgICAgICAgICAgbGFzdF9zZWVuOiBtb21lbnQoKS52YWx1ZU9mKCksXG4gICAgICAgICAgICB2aXBfZXhwaXJ5OiBtb21lbnQoKS5hZGQoMzAsIFwiZGF5c1wiKS52YWx1ZU9mKClcbiAgICAgICAgfVxuICAgIH1cbmxldCBzZXJ2ZXJcblxudHJ5IHtcbiAgICBzZXJ2ZXIgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7cG9ydDogcHJvZ3JhbS5wb3J0fSlcbn0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnJvcilcbiAgICBwcm9jZXNzLmV4aXQoMSlcbn1cblxuc2VydmVyLm9uKFwiY29ubmVjdGlvblwiLCAoY2xpZW50LCBtZXNzYWdlKSA9PiB7XG5cbiAgICBsZXQgaXNBdXRob3JpemVkID0gcHJvZ3JhbS5hdXRoQWxsXG4gICAgY29uc3QgY2xpZW50TmFtZSA9IG1lc3NhZ2UuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzXG5cbiAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbihgWyR7Y2xpZW50TmFtZX1dIENvbm5lY3RlZCFgKSlcbiAgICBjbGllbnQub24oXCJtZXNzYWdlXCIsIG1lc3NhZ2UgPT4ge1xuXG4gICAgICAgIGNvbnN0IFthcGlOYW1lLCBjb21tYW5kLCAuLi5hcmdzXSA9IG1lc3NhZ2Uuc3BsaXQoXCJ8XCIpXG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJsdWUoYFske2NsaWVudE5hbWV9XSDwn6G6ICR7SlNPTi5zdHJpbmdpZnkoe2FwaU5hbWU6IGFwaU5hbWUsIGNvbW1hbmQ6IGNvbW1hbmQsIGFyZ3M6IGFyZ3N9KX1gKSlcblxuICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCBsb2Rhc2gucmFuZG9tKDAsIHByb2dyYW0ucmFuZG9tTGF0ZW5jeSkpXG4gICAgICAgIH0pLnRoZW4oKCkgPT4gcmVzb2x2ZUFwaUNhbGwoaXNBdXRob3JpemVkLCBhcGlOYW1lLCBjb21tYW5kLCBhcmdzKSlcbiAgICAgICAgICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyYXkoYFske2NsaWVudE5hbWV9XSDwn6G4ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCkpXG4gICAgICAgICAgICAgICAgY2xpZW50LnNlbmQoSlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgNCkpXG4gICAgICAgICAgICB9KS5jYXRjaChlcnJvciA9PiBjb25zb2xlLmxvZyhjaGFsay5ncmF5KGBbJHtjbGllbnROYW1lfV0g4pqgICR7ZXJyb3J9YCkpKVxuXG5cbiAgICB9KVxuICAgIGNsaWVudC5vbihcImNsb3NlXCIsICgpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsucmVkKGBbJHtjbGllbnROYW1lfV0gRGlzY29ubmVjdGVkIWApKVxuICAgIH0pXG59KVxuXG5jb25zb2xlLmxvZyhjaGFsay55ZWxsb3coYERlZXBib3QgQVBJIFdlYlNvY2tldCBydW5uaW5nIG9uIHdzOi8vMTI3LjAuMC4xOiR7cHJvZ3JhbS5wb3J0fWApKVxuaWYgKHByb2dyYW0uYXV0aEFsbCkge1xuICAgIGNvbnNvbGUubG9nKGNoYWxrLnllbGxvdyhgLS1hdXRoLWFsbCBpcyBlbmFibGVkYCkpXG59IGVsc2Uge1xuICAgIGNvbnNvbGUubG9nKGNoYWxrLnllbGxvdyhgWW91IGNhbiBsb2cgaW4gd2l0aCBhcGl8cmVnaXN0ZXJ8JHtwcm9ncmFtLmFwaUtleX1gKSlcbn1cblxucHJvY2Vzcy5zdGRpbi5zZXRFbmNvZGluZyhcInV0ZjhcIilcbnByb2Nlc3Muc3RkaW4ub24oXCJyZWFkYWJsZVwiLCAoKSA9PiB7XG4gICAgY29uc3QgY2h1bmsgPSBwcm9jZXNzLnN0ZGluLnJlYWQoKVxuICAgIGlmIChjaHVuayAhPT0gbnVsbCkge1xuICAgICAgICAvLyBOb3RoaW5nIHRvIGRvIHdpdGggQ0xJIGlucHV0XG4gICAgfVxufSlcblxuZnVuY3Rpb24gcmVzb2x2ZUFwaUNhbGwoaXNBdXRob3JpemVkLCBhcGlOYW1lLCBjb21tYW5kLCBhcmdzKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICBpZiAoYXBpTmFtZSAhPT0gXCJhcGlcIikge1xuICAgICAgICAgICAgcmVqZWN0KGBGaXJzdCBwYXJhbWV0ZXIgbXVzdCBiZSBcImFwaVwiLCBidXQgaXQgaXMgJHthcGlOYW1lfWApXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY29tbWFuZCkge1xuICAgICAgICAgICAgcmVqZWN0KGBjb21tYW5kIGlzICR7Y29tbWFuZH1gKVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29tbWFuZCA9PT0gXCJyZWdpc3RlclwiKSB7XG4gICAgICAgICAgICBpZiAoYXJnc1swXSA9PT0gcHJvZ3JhbS5hcGlLZXkpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHtcImZ1bmN0aW9uXCI6IFwicmVnaXN0ZXJcIiwgcGFyYW06IFwicmVnaXN0ZXJcIiwgbXNnOiBcInN1Y2Nlc3NcIn0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoe1wiZnVuY3Rpb25cIjogXCJyZWdpc3RlclwiLCBwYXJhbTogXCJlcnJvclwiLCBtc2c6IFwiaW5jb3JyZWN0IGFwaSBzZWNyZXRcIn0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpc0F1dGhvcml6ZWQgPSB0cnVlXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghaXNBdXRob3JpemVkKSB7XG4gICAgICAgICAgICByZXNvbHZlKHtcImZ1bmN0aW9uXCI6IGNvbW1hbmQsIHBhcmFtOiBcImVycm9yXCIsIG1zZzogXCJub3QgYXV0aG9yaXplZFwifSlcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbW1hbmQgPT09IFwiZ2V0X3VzZXJcIikge1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IHVzZXJEYXRhW2FyZ3NbMF1dXG4gICAgICAgICAgICBpZiAodXNlcikge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoe1wiZnVuY3Rpb25cIjogY29tbWFuZCwgcGFyYW06IGFyZ3NbMF0sIG1zZzogdXNlclRvSnNvbih1c2VyKX0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlamVjdChgVXNlciAke2FyZ3NbMF19IG5vdCBmb3VuZCFgKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29tbWFuZCA9PT0gXCJnZXRfcG9pbnRzXCIpIHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSB1c2VyRGF0YVthcmdzWzBdXVxuICAgICAgICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgICAgICAgICBudW1lcmFsLmxvY2FsZShcImRlXCIpXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh7XCJmdW5jdGlvblwiOiBjb21tYW5kLCBwYXJhbTogYXJnc1swXSwgbXNnOiBudW1lcmFsKHVzZXIucG9pbnRzKS5mb3JtYXQoXCIwLjAwXCIpfSlcbiAgICAgICAgICAgICAgICBudW1lcmFsLmxvY2FsZShcImVuXCIpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlamVjdChgVXNlciAke2FyZ3NbMF19IG5vdCBmb3VuZCFgKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29tbWFuZCA9PT0gXCJhZGRfcG9pbnRzXCIpIHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSB1c2VyRGF0YVthcmdzWzBdXVxuICAgICAgICAgICAgY29uc3QgcG9pbnRzVG9BZGQgPSBhcmdzWzFdXG4gICAgICAgICAgICBpZiAodXNlcikge1xuICAgICAgICAgICAgICAgIGlmICghcG9pbnRzVG9BZGQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KFwiTWlzc2luZyBwYXJhbWV0ZXIhXCIpXG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB1c2VyLnBvaW50cyArPSBwb2ludHNUb0FkZFxuICAgICAgICAgICAgICAgIHJlc29sdmUoe1wiZnVuY3Rpb25cIjogY29tbWFuZCwgcGFyYW06IGFyZ3NbMF0sIG1zZzogXCJzdWNjZXNzXCJ9KVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZWplY3QoYFVzZXIgJHthcmdzWzBdfSBub3QgZm91bmQhYClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICB9KVxufVxuXG5mdW5jdGlvbiB1c2VyVG9Kc29uKHVzZXIpIHtcbiAgICByZXR1cm4ge1xuICAgICAgICB1c2VyOiB1c2VyLnVzZXIsXG4gICAgICAgIHBvaW50czogbnVtZXJhbCh1c2VyLnBvaW50cykuZm9ybWF0KFwiMC4wXCIpLFxuICAgICAgICB3YXRjaHRpbWU6IG51bWVyYWwodXNlci53YXRjaHRpbWUpLmZvcm1hdChcIjAuMFwiKSxcbiAgICAgICAgdmlwOiB1c2VyLnZpcCxcbiAgICAgICAgbW9kOiB1c2VyLm1vZCxcbiAgICAgICAgam9pbl9kYXRlOiBtb21lbnQodXNlci5qb2luX2RhdGUpLmZvcm1hdCgpLFxuICAgICAgICBsYXN0X3NlZW46IG1vbWVudCh1c2VyLmxhc3Rfc2VlbikuZm9ybWF0KCksXG4gICAgICAgIHZpcF9leHBpcnk6IG1vbWVudCh1c2VyLnZpcF9leHBpcnkpLmZvcm1hdCgpXG4gICAgfVxufSJdfQ==
